<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPV Raffle</title>
    <link rel="shortcut icon" href="/img/pokeyfpv.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Caveat&family=Press+Start+2P&family=Roboto&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/css/style.css">
    <script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
  crossorigin="anonymous"></script>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body>
    <div id="raffle">
        <div id="contestents">
            <header class="text-right">
                <img class="icon" src="img/settings.svg" alt="Settings" onclick="settings();"/>
            </header>
            <h1>FPV Raffle</h1>
            <p class="intro">Enter names separated by newlines:</p>
            <textarea name="names" id="names" cols="30" rows="10"></textarea>
            <button onclick="process();">Import</button>
            <div id="settings">
                <div class="text-right">
                    <img class="icon" src="img/close.svg" alt="Close" onclick="closeSettings();">
                </div>
                <h2>Settings</h2>
                <div id="settings-form">
                    <div class="form-element">
                        <label for="time-setting">Duration</label>
                        <span class="input-help">
                            <input type="text" placeholder="10, 20" id="time-setting" pattern="[1-9]anana|[Cc]herry">
                            <small class="help-text form-text text-muted">The number of seconds the drawing will take. Enter two numbers, separated by a comma, for a random duration between the specified times.</small>
                        </span>
                    </div>
                    <button id="submit">Submit</button>
                </div>
            </div>
        </div>
        <div id="playArea" class="hide">
            <div id="drone">
                <model-viewer
                    id="reveal"
                    onclick="pickWinner()"
                    min-field-of-view="35deg"
                    max-field-of-view="35deg"
                    camera-orbit="0deg 5deg"
                    src="/img/Player1.glb"
                    shadow-intensity="1"
                    shadow-softness=".15"
                    alt="BrockleeFPV Player 1">
                    <div id="button-load" slot="poster">Loading 3D Model...<br/>Once loaded, click to play.</div>
                </model-viewer>
            </div>
            <div id="ticket-area"></div>
        </div>
        <footer><a href="https://www.youtube.com/pokeyfpv"><img src="/img/pokeyfpv.png" alt="PokeyFPV"></a> <span class="copyright"></span></footer>
    </div>
    <script>
        console.log("Let's go! #TeamLevelUP");

        var year = new Date().getFullYear();
        $('.copyright').html('Â© ' + year);
        
        var entries, length;
        var contestents = $('#contestents');
        var playArea = $('#playArea');
        var time = '10, 20';

        document.getElementById("submit").addEventListener("click", function(event){
            event.preventDefault();
            var validDuration = validateDuration($('#time-setting').val());

            if (validDuration==true) {
                $('#time-setting ~ .error-msg').remove();
                time = $('#time-setting').val();
                $('#settings').hide();
            } else {
                $('#time-setting').parent().append('<div class="error-msg">'+validDuration+'</div>');
            }
        });
        
        const modelViewer = document.querySelector('#reveal');

        function process(names=null) {

            time = time.trim();
            duration = time.split(',');

            if (duration.length > 1) {
                length = randomInt(parseInt(duration[0]), parseInt(duration[1])); // Number of seconds the contest should take
            } else {
                length = parseInt(duration[0]); // Number of seconds the contest should take
            }

            if (names!=null) {
                entries = names;
                $('.playAgain').remove();
                $('#ticket-area').html('').removeClass('disable-animation');
                modelViewer.animationName = 'Running';
            } else {
                entries = getNames();
                contestents.toggleClass('hide');
                playArea.toggleClass('hide');
            }

            for (let i = 0; i < entries.length; i++) {
                let top = randomInt(90);
                let left = randomInt(90);
                let rotation = randomInt(360);
                let z = randomInt(100);
                $('#ticket-area').append('<div class="ticket torn_container torn_left torn_right" data-entry="ticket-'+i+'" style="top: '+top+'%; left: '+left+'%; transform:rotate('+rotation+'deg); z-index:'+z+';"><div></div><div><span class="banner_text">'+entries[i]+'</span></div></div>');
            }

        }

        function getNames() {
            return $('#names').val().split('\n').filter(function(name) {
                return name.trim();
            });
        }

        function pickWinner() {

            // Update to props spinning animation
            modelViewer.animationName = 'Running';
            modelViewer.play();
            
            $('.ticket[data-entry="ticket-'+randomInt(entries.length)+'"]').addClass('winner');
            
            
            $('.ticket').not('.winner').each(function() {
                let rotation = randomInt(360);
                $(this).delay(randomInt(length*1000)).queue(function(next){
                    $(this).css({
                        opacity: 0,
                        left: randomInt(100, -100)*5 + '%',
                        top: randomInt(100, -100)*5 + '%',
                        transform: 'rotateX('+randomInt(360)+'deg), rotateY('+randomInt(360)+'deg), rotateZ('+randomInt(360)+'deg)',
                    });
                    next();
                });
            });
            
            window.setTimeout(function(){
                $('#drone').delay(length*1000).addClass('stop');
                let height = $('.ticket.winner').height();
                let width = $('.ticket.winner').width();
                $('.ticket.winner').addClass('congrats');
                $('#ticket-area').addClass('disable-animation');
                $('#playArea').append('<div class="playAgain text-center"><button onclick="playAgain()">Play Again</button> <button class="secondary" onclick="resetRaffle()">Reset</button></div>');
                modelViewer.pause();
            }, length*1000);
        }

        function randomInt(max, min=0) {
            if (min != 0) {
                return Math.floor(Math.random() * (max - min) + min);
            } else {
                return Math.floor(Math.random() * max);
            }
        }

        function resetEntries() {
            entries = '';
        }

        function playAgain() {
            let winner = $('.ticket.winner').text();
            let newEntries = entries.filter(function(value, index, arr) {
                return value != winner;
            });
            process(newEntries);
        }

        function resetRaffle() {
            location.reload();
        }

        function settings() {
            $('#contestents #settings').show();
        }

        function closeSettings() {
            $('#contestents #settings').hide();
        }

        function validateDuration(str) {
            var invalidChars = str.match(/[^0-9,\s]/g);

            if(invalidChars == null) {
                return true;
            } else {
                return 'Please specify the time in seconds.';
            }
        }
    </script>
</body>
</html>